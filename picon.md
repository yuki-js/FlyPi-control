# Fly Pi v2.1

前回コンテストに出した、ラズパイドローンFlyPiは、浮き上がったものの大破してしまいました。その反省を踏まえて、「Zeroでイチから」作り直しました。
初代Fly Piとの変更点は

* 電子回路を刷新し、SeeedStudio FusionPCBでプリント基板を製造した点
* Raspberry Pi 1BをZero Wに変えた点
* その結果、軽量化した点
    - 75g(バッテリなし) 半分の重さに
* 制御プログラムをC言語で作り直した点
* 加速度に加え、ジャイロセンサーも搭載
* モーターが8個に増えたこと
* フライトコントローラーのUIを刷新し、高機能化した点
    - 誤操作を抑制するUI
* オン抵抗が小さいチップMOSFETを使った点

初代Fly Piから継承している特徴は

* WiFiで制御できる
* Raspberry Piを搭載しているので処理性能が高く、汎用性が高い
* ブラウザで操作できるので、アプリ不要
* 加速度センサー搭載

### 主な材料
* Fly Pi プリント基板
* Raspberry Pi Zero W
* FP6291
* MPU-6050 加速度＆ジャイロセンサ
* チップ抵抗
* チップコンデンサ
* チップインダクタ 3.3μH
* チップMOSFET IRLML6344TRPBFTR
* コアレスモーター M716PA-10
* 8mm x 6mm桧
* IU233


### 作り方
1. 基板に部品を取り付ける。
1. 基板にRaspberry Pi Zero Wの、基板と配線されているピンをはんだ付けする
1. フレームを作る
    1. 8mmx6mm桧棒に150mm間隔で7mmの穴を開ける。
    1. 穴の両端の薄くなったところをカッターで切る。
    1. 基板のネジ穴に合わせて穴を開ける。
    1. 削って井の字に組む
1. モーターを取り付ける
1. Raspbian LiteをSDカードにインストールする
1. WiFiアクセスポイントと制御ソフトを設定する
1. ブラウザから制御してモーターを回す

### 使い方
動画での解説は、https://www.youtube.com/watch?v=n-6DBuJhM90&feature=youtu.be


1. 制御ソフトウェアを起動する
1. フライトコントローラーサーバーを起動し、制御ソフトウェアとTCP接続しブラウザを起動する
1. Optionタブで、Sensor Enabledなどのオプション、パラメータを確認、設定する
1. 機体を傾けるとモーターが動くことを確認する
1. Controllerタブで操作する
1. 飛び方をOptionタブで調整する

### プロトコル
#### 制御ソフトウェア(C言語) ← フライトコントローラーサーバー(Node.js) ← フライトコントローラー(ブラウザ)
1バイト目でパケットの種類を宣言し、それに応じて2バイト以降に、構造体を送信します。ブラウザから送信データをJSONに変換して、Nodeが中継し、制御ソフトウェアが命令を解釈します。
パケット種類の定義はpacketBits.hにあります。
#### 制御ソフトウェア(C言語) → フライトコントローラーサーバー(Node.js) → フライトコントローラー(ブラウザ)
同様にNodeが中継し、パケットサイズからパケット種類を識別し、それに応じてブラウザが構造体を解釈します。


### 利用したライブラリなど
#### 制御ソフトウェア
* gcc
* pigpio C interface
* gulp
* libssp 1.62

#### フライトコントローラー
* node.js v6.11.2
* Vue.js
* engine.io

### 製作環境
* Windows 7
* KiCad
* Emacs
* macOS Sierra
* Raspberry Pi
    * 3
    * Zero
    * Zero W

## アピールポイント

 一番に、ソースコードです。性能を最大限に引き出すためC言語でのGPIO[^1]の制御方法を学び、生のTCP[^2]パケットを扱って無駄なく通信できるようにし、加速度センサーと通信するためのライブラリがなかったので作りました。MultiWiiに代表されるドローン用のライブラリなどは使っていません。制御用にpigpioを使っただけです。はじめはなかなか動かなかったけれど、Node.jsなど他の言語の実装も参考にして動かすことができました。C言語に代表される型付き言語はあまり使ったことがなかったので、思わぬところで型のエラーが発生して、*コンパイルに困憊*しました。
 
 コントローラー側は、パケットを見やすく表示したり、プロポ[^3]と同じキー配列にして熟練者でも操作しやすくしたりといったところを工夫しました。JavaScriptと、C言語の構造体の間の変換が難しかったです。今までエンディアン[^4]の差はバーチャルマシンが吸収していましたが、今回はエンディアン変換をしなければならなかったので、手間がかかりました。

 二番目に、基板です。表面実装部品を使い、軽量化しました。なるべくエラーを避けるため、パターンの最小間隔のルールを、パターン印刷の最小値よりも大きい値にし、厳しいルールの上で、ゆとりを持たせました。部品点数を減らすためにスイッチング電源回路を自作したり、基板の形状を工夫したりもしました。
 表面実装部品のはんだ付けは大変でした。とても細かい上に熱に弱いため、素早く正確にはんだ付けしなければいけませんでした。はんだ付けミスからモーターが異常回転することもありました。それから、表面実装部品のサイズがパターンと買ってきたもので違うこともありました。
 
他にも細かいところに気を配りました。例えば、間違えてモーターが回らないように、アームボタンを押さないと起動できないようにしました。また、コントローラーのExpertタブでパケットを編集できるのですが、16進数、バイナリ、文字列の3形式で入力でき、スペースで区切り読みやすくしました。そして、ネジの配置が、1リットルの牛乳パックにぴったりはまるサイズになっています。これによりはんだ付けの際に安定させることができます。Nintendo Switch のコントローラー Joy-Conで操作できるようにしました。

### 作品への思い
前回のFly Piは、空撮をしたいという思いのもと、技術力が乏しいにもかかわらず、ドローンを作ろうとしたが、壊れて失敗に終わってしまいました。その後、敗因を分析してみると、トランジスタの分の電圧が下がってしまうこと、初代Raspberry Piをいくら軽量化しようともZeroの軽さには敵わないこと、制御するにはJavaScriptは応答が遅いこと、P制御だけで姿勢安定化はできないこと、ハンダを盛りすぎたこと、MOSFETの存在を知らなかったことなどが考えられました。調べていくうちに、しっかりしたものを作れば飛ぶのではないかと思いました。C言語、CAD、表面実装部品などを勉強して、イチから作り直しました。そして、Zeroを入手したので、ユニバーサル基板の試作品が飛びそうなところまで行きました。軽量化すればなんとかなると思い、基板を発注しました。その結果、浮力が重力より大きくなりました。そして、地面から離れることはできました。応募時点では、パラメータ設定をしていないのでホバリングはできていません。しかし、パラメータ設定をすれば、うまく行くに違いない。

### 苦労したところ

(苦労した順)

1. Raspberry Pi Zero Wが6ヶ月間日本で発売されず、開発が止まっていたところ。
1. 私が長年愛用してきたJavaScriptとC言語のファイル規約が全く違うので、C言語の考えが理解できなかったところ。
1. 生のTCPも、ビット演算も初めてだったので、頻繁にバグを起こしたこと
1. 家のWiFiルータと作業場の距離が遠いので、非力なZero Wの電波状況が悪く、通信が頻繁に途絶えたところ
1. PID制御の実装部分
1. 別のコンテストのための開発と同時並行していたため、時間が取りづらかったところ
1. 型付き言語はあまり使ったことがなかったので、思わぬところで型のエラーが発生して、*コンパイルに困憊*したところ(これを言いたかった)

### 今後の課題、アイデア
 現在、フレームが木材なので、市販のドローンのようにプラスチックのフレームでプロペラ、基板を保護したいです。そのために3Dプリンタを使えるようになりたいです。
 IU233は、今のところ、SSPライブラルだけでしか動作せず、公式カメラモジュールのようにハードウェア支援を使うことができず、CPU使用率が高いです。仕方がないので、今のところ1秒ごとに写真を撮って、クライアントが取得する状態です。リアルタイムかつ高画質だが低ビットレート、低負荷なカメラ映像配信を実現したいです。
 OpenCVで人を追いかけるといったことをしたいです。
 飛行時間が短いので、モーターカーと組み合わせて、台車が進めないところへドローンが行ける、というようなものを作りたいです。
 操作方法を格好良く、見栄えをよくしたいです。音声認識とか、Kinectが面白そうです。今私が考えているものでは、指先にTWE-Lite-2525Aを取り付けて、ちょっと動かすだけで操作でき、ぱっと見ドローンを操作しているようには見えないような操作をしたいです。

[^1]: GPIOとは、General Purpose Input and Outputの略で、信号の入出力をします。Fly Piでは、モーターの出力をこれで制御します。

[^2]: TCPとは、Transmission Control Protocolの略で、コンピュータ間の通信で頻繁に用いられるプロトコルです。インターネットに欠かせません

[^3]: プロポとは、プロポーショナル・コントローラの略で、一般的にドローンの操作はこれで行います。

[^4]: エンディアンとは、メモリ上のデータ順序のこと。CPUによって異なり、Raspberry Piはリトルエンディアンで、人間に優しくないデータ順序。
